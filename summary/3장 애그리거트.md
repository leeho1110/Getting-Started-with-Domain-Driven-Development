# 3장: 애그리거트

### 1. 애그리거트

- 우리가 실무에서 접하는 도메인 모델은 복잡하다. 이 때 상위 도메인 모델 수준에서 복잡함을 보다 이해하기 쉽고 관리하기 편하게 만들기 위해선 특정 단위로 묶어 관리하는 것이 좋다. 이를 **애그리거트**라고 한다.
    - 애그리거트 단위로 도메인 모델을 관리하면 이해하기 쉽다는 장점 외에도 일관성을 관리할 수 있다.
    - 도메인 모델은 반드시 하나의 애그리거트에 포함된다. 따라서 도메인 규칙이나 요구사항에 따라 각 애그리거트들의 경계를 정해 도메인 모델을 분류해야 한다.
        - 만약 2개의 도메인 모델이 변경될 때 서로에게 영향을 주지 않는다면, 이 둘은 다른 애그리거트에 속해야 한다.
        - 저자는 애그리거트를 생성할 때 최초엔 커보이지만, 도메인 지식이 늘어날수록 줄어든다고 말한다. 저자의 경험으론 일반적으로 애그리거트와 엔티티 객체가 1:1 형태로 구성되는 경우가 많다고 한다.
- 애그리거트는 관련된 도메인 모델을 하나로 묶은 단위라고 했다. 따라서 애그리거트 내부의 도메인 모델은 대부분 유사하거나 동일한 라이프 사이클을 갖게 된다.

---

### 2. 애그리거트 루트

- 애그리거트는 여러 도메인 모델이 하나로 묶인 군집이다. 따라서 도메인 규칙에 따라 기능이 실행될 때 애그리거트에 속한 모든 객체들은 **반드시 정상 상태**를 가져야 한다. 이 때 **모든 객체들을 일관된 정상 상태로 유지시킬 책임**을 갖는 객체가 바로 **애그리거트의 루트 엔티티**이다. 애그리거트 루트라고도 한다.
    - 이 때 애그리거트 외부에서 애그리거트에 속한 객체를 직접 변경해선 안된다. 이는 애그리거트 루트가 적용하는 규칙에서 벗어나 애그리거트의 내부 일관성을 깨뜨리는 원인 중 하나다.
        - 이를 지키기 위해서 도메인 모델은 단순한 필드 변경을 수행하는 **set 메서드는 `public` 접근 제어자로 만들지 않고,** **밸류는 불변 객체로 구현**해야 한다.
        - 자바 빈즈 규약에 따라 습관적으로 만드는 `getter`, `setter` 에서 `setter` 는 반드시 피하는 것이 좋다. 만약 필드 변경이 필요하다면 의미가 드러나는 이름을 사용하자.
- 서비스를 구현하며 중요한 것 중 하나는 트랜잭션이다. 일반적인 경우 트랜잭션 범위는 작은 것이 좋다.
    - 수정해야할 테이블이 늘어나면 그만큼 얻어야 하는 락의 범위가 커진다. 이는 접근할 수 있는 트랜잭션 개수의 감소를 의미하므로 자연스럽게 성능이 하락한다.
    - 하나의 트랜잭션에선 하나의 애그리거트만 수정해야한다.
    - 만약 하나의 트랜잭션에서 여러 개의 애그리거트를 수정해야한다면 응용 서비스에서 트랜잭션을 설정해 수정하도록 구현하자. 혹은 도메인 이벤트를 활용할 수 있다.

---